<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¹´ä¼šæŠ½å¥–ç³»ç»Ÿ</title>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "Microsoft YaHei", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 50px rgba(0,0,0,0.3);
        }

        h1 {
            text-align: center;
            color: #667eea;
            margin-bottom: 30px;
            font-size: 2.5em;
        }

        .tab-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            justify-content: center;
        }

        .tab-btn {
            padding: 12px 30px;
            border: none;
            background: #f0f0f0;
            cursor: pointer;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
        }

        .tab-btn.active {
            background: #667eea;
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* ç­¾åˆ°é¡µé¢æ ·å¼ */
        .signin-form {
            max-width: 500px;
            margin: 0 auto;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }

        input[type="text"], input[type="tel"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border 0.3s;
        }

        input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-success {
            background: #51cf66;
            color: white;
        }

        .btn-danger {
            background: #ff6b6b;
            color: white;
        }

        .message {
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            text-align: center;
            font-size: 16px;
        }

        .success {
            background: #d3f9d8;
            color: #2b8a3e;
        }

        .error {
            background: #ffe3e3;
            color: #c92a2a;
        }

        /* æŠ½å¥–é¡µé¢æ ·å¼ */
        .lottery-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .lottery-controls input {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            width: 150px;
        }

        .draw-btn {
            padding: 15px 40px;
            font-size: 20px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            font-weight: bold;
            transition: transform 0.2s;
        }

        .draw-btn:hover {
            transform: scale(1.05);
        }

        .draw-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: scale(1);
        }

        .winner-display {
            text-align: center;
            padding: 40px;
            background: linear-gradient(135deg, #ffd89b 0%, #19547b 100%);
            border-radius: 15px;
            margin: 30px 0;
            min-height: 150px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .winner-display h2 {
            color: white;
            font-size: 3em;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .winner-display .winner-name {
            font-size: 2.5em;
            color: #ffd700;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        /* å‚ä¸è€…åˆ—è¡¨ */
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-card h3 {
            font-size: 1.2em;
            margin-bottom: 10px;
        }

        .stat-card .number {
            font-size: 2.5em;
            font-weight: bold;
        }

        .winners-list {
            margin-top: 30px;
        }

        .prize-section {
            margin-bottom: 30px;
            border: 2px solid #ddd;
            border-radius: 10px;
            padding: 20px;
        }

        .prize-section h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.5em;
        }

        .winner-item {
            display: inline-block;
            background: #f8f9fa;
            padding: 8px 15px;
            margin: 5px;
            border-radius: 20px;
            border: 2px solid #667eea;
        }

        .participants-list {
            max-height: 400px;
            overflow-y: auto;
            border: 2px solid #ddd;
            border-radius: 10px;
            padding: 15px;
        }

        .participant-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
        }

        .participant-item:last-child {
            border-bottom: none;
        }

        .delete-btn {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 5px 15px;
            border-radius: 5px;
            cursor: pointer;
        }

        .delete-btn:hover {
            background: #ee5a52;
        }

        /* äºŒç»´ç åŒºåŸŸ */
        .qrcode-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .qrcode-section h3 {
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        #qrcode {
            background: white;
            padding: 20px;
            border-radius: 10px;
            display: inline-block;
            margin: 20px auto;
        }

        .qrcode-url {
            background: rgba(255,255,255,0.2);
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            word-break: break-all;
            font-family: monospace;
        }

        .mobile-tip {
            background: #fff3cd;
            border: 2px solid #ffc107;
            color: #856404;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        /* ç®¡ç†é¡µé¢ */
        .admin-actions {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 1.8em;
            }
            
            .tab-buttons {
                flex-direction: column;
            }
            
            .lottery-controls {
                flex-direction: column;
            }
            
            .lottery-controls input {
                width: 100%;
            }
            
            .winner-display h2 {
                font-size: 2em;
            }
            
            .winner-display .winner-name {
                font-size: 1.8em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ‰ å¹´ä¼šæŠ½å¥–ç³»ç»Ÿ ğŸ‰</h1>

        <div class="tab-buttons">
            <button class="tab-btn active" onclick="switchTab('signin')">ç­¾åˆ°</button>
            <button class="tab-btn" onclick="switchTab('lottery')">æŠ½å¥–</button>
            <button class="tab-btn" onclick="switchTab('manage')">ç®¡ç†</button>
        </div>

        <!-- ç­¾åˆ°é¡µé¢ -->
        <div id="signin" class="tab-content active">
            <div class="signin-form">
                <div class="mobile-tip" id="mobileTip" style="display: none;">
                    âœ¨ æ¬¢è¿å‚åŠ å¹´ä¼šï¼è¯·å¡«å†™ä¿¡æ¯å®Œæˆç­¾åˆ°
                </div>
                <h2 style="text-align: center; margin-bottom: 30px;">å‘˜å·¥ç­¾åˆ°</h2>
                <form onsubmit="signIn(event)">
                    <div class="form-group">
                        <label for="name">å§“å</label>
                        <input type="text" id="name" required placeholder="è¯·è¾“å…¥å§“å">
                    </div>
                    <div class="form-group">
                        <label for="phone">æ‰‹æœºå·</label>
                        <input type="tel" id="phone" required placeholder="è¯·è¾“å…¥æ‰‹æœºå·">
                    </div>
                    <button type="submit" class="btn btn-primary">ç­¾åˆ°</button>
                </form>
                <div id="signinMessage"></div>
            </div>
        </div>

        <!-- æŠ½å¥–é¡µé¢ -->
        <div id="lottery" class="tab-content">
            <div class="stats">
                <div class="stat-card">
                    <h3>å·²ç­¾åˆ°</h3>
                    <div class="number" id="totalParticipants">0</div>
                </div>
                <div class="stat-card">
                    <h3>æœªä¸­å¥–</h3>
                    <div class="number" id="remainingParticipants">0</div>
                </div>
                <div class="stat-card">
                    <h3>å·²ä¸­å¥–</h3>
                    <div class="number" id="totalWinners">0</div>
                </div>
            </div>

            <div class="lottery-controls">
                <select id="prizeType" style="padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;">
                    <option value="ä¸€ç­‰å¥–">ä¸€ç­‰å¥–</option>
                    <option value="äºŒç­‰å¥–" selected>äºŒç­‰å¥–</option>
                    <option value="ä¸‰ç­‰å¥–">ä¸‰ç­‰å¥–</option>
                </select>
                <input type="number" id="drawCount" placeholder="æŠ½å–äººæ•°" min="1" value="1">
                <button class="draw-btn" onclick="startDraw()">å¼€å§‹æŠ½å¥–</button>
            </div>

            <div class="winner-display" id="winnerDisplay">
                <h2>å‡†å¤‡å¼€å§‹æŠ½å¥–</h2>
                <p style="color: white; font-size: 1.2em;">é€‰æ‹©å¥–é¡¹å’Œäººæ•°ï¼Œç‚¹å‡»å¼€å§‹æŠ½å¥–</p>
            </div>

            <div class="winners-list" id="winnersList"></div>
        </div>

        <!-- ç®¡ç†é¡µé¢ -->
        <div id="manage" class="tab-content">
            <div class="qrcode-section">
                <h3>ğŸ“± æ‰‹æœºæ‰«ç ç­¾åˆ°</h3>
                <p>å‘˜å·¥ä½¿ç”¨æ‰‹æœºæ‰«æä¸‹æ–¹äºŒç»´ç å³å¯è¿›å…¥ç­¾åˆ°é¡µé¢</p>
                <div id="qrcode"></div>
                <div class="qrcode-url">
                    <strong>ç­¾åˆ°é“¾æ¥ï¼š</strong><br>
                    <span id="signinUrl"></span>
                </div>
                <button class="btn btn-primary" onclick="refreshQRCode()" style="margin-top: 15px;">åˆ·æ–°äºŒç»´ç </button>
            </div>

            <div class="admin-actions">
                <button class="btn btn-danger" onclick="clearAllData()">æ¸…ç©ºæ‰€æœ‰æ•°æ®</button>
                <button class="btn btn-success" onclick="exportData()">å¯¼å‡ºæ•°æ®</button>
                <button class="btn btn-primary" onclick="importData()">å¯¼å…¥æ•°æ®</button>
            </div>

            <h3 style="margin-bottom: 15px;">ç­¾åˆ°äººå‘˜åˆ—è¡¨ (<span id="participantCount">0</span>äºº)</h3>
            <div class="participants-list" id="participantsList"></div>

            <input type="file" id="importFile" style="display: none;" accept=".json" onchange="handleImport(event)">
        </div>
    </div>

    <script>
        // Firebaseé…ç½® - è¯·æ›¿æ¢ä¸ºä½ è‡ªå·±çš„é…ç½®
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT.firebaseapp.com",
            databaseURL: "https://YOUR_PROJECT.firebaseio.com",
            projectId: "YOUR_PROJECT",
            storageBucket: "YOUR_PROJECT.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // åˆå§‹åŒ–Firebase
        let database;
        let useFirebase = false;
        
        try {
            if (firebaseConfig.apiKey !== "YOUR_API_KEY") {
                firebase.initializeApp(firebaseConfig);
                database = firebase.database();
                useFirebase = true;
                console.log('Firebaseå·²å¯ç”¨');
            } else {
                console.log('ä½¿ç”¨æœ¬åœ°å­˜å‚¨æ¨¡å¼');
            }
        } catch (error) {
            console.log('Firebaseåˆå§‹åŒ–å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°å­˜å‚¨:', error);
        }

        // æ•°æ®ç»“æ„
        let participants = []; // æ‰€æœ‰ç­¾åˆ°äººå‘˜
        let winners = {
            'ä¸€ç­‰å¥–': [],
            'äºŒç­‰å¥–': [],
            'ä¸‰ç­‰å¥–': []
        };

        // åˆå§‹åŒ–
        window.onload = function() {
            if (useFirebase) {
                loadDataFromFirebase();
            } else {
                loadData();
            }
            updateStats();
            updateParticipantsList();
            updateWinnersList();
            generateQRCode();
            
            // æ£€æŸ¥URLå‚æ•°ï¼Œå¦‚æœæ˜¯ç­¾åˆ°æ¨¡å¼åˆ™ç›´æ¥æ˜¾ç¤ºç­¾åˆ°é¡µé¢
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('mode') === 'signin') {
                // éšè—æ ‡ç­¾æŒ‰é’®ï¼Œåªæ˜¾ç¤ºç­¾åˆ°é¡µé¢
                document.querySelector('.tab-buttons').style.display = 'none';
                document.getElementById('mobileTip').style.display = 'block';
                switchTab('signin');
            }
        };

        // åˆ‡æ¢æ ‡ç­¾
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            updateStats();
            updateParticipantsList();
            updateWinnersList();
        }

        // ç­¾åˆ°åŠŸèƒ½
        function signIn(event) {
            event.preventDefault();
            
            const name = document.getElementById('name').value.trim();
            const phone = document.getElementById('phone').value.trim();
            const messageDiv = document.getElementById('signinMessage');

            // éªŒè¯æ‰‹æœºå·
            if (!/^1[3-9]\d{9}$/.test(phone)) {
                showMessage(messageDiv, 'è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·', 'error');
                return;
            }

            // æ£€æŸ¥æ˜¯å¦å·²ç­¾åˆ°
            if (participants.some(p => p.phone === phone)) {
                showMessage(messageDiv, 'è¯¥æ‰‹æœºå·å·²ç­¾åˆ°ï¼Œè¯·å‹¿é‡å¤ç­¾åˆ°ï¼', 'error');
                return;
            }

            // æ·»åŠ å‚ä¸è€…
            participants.push({
                name: name,
                phone: phone,
                signTime: new Date().toLocaleString('zh-CN')
            });

            saveData();
            showMessage(messageDiv, `${name}ï¼Œç­¾åˆ°æˆåŠŸï¼`, 'success');
            
            // æ¸…ç©ºè¡¨å•
            document.getElementById('name').value = '';
            document.getElementById('phone').value = '';
            
            updateStats();
        }

        // å¼€å§‹æŠ½å¥–
        function startDraw() {
            const prizeType = document.getElementById('prizeType').value;
            const drawCount = parseInt(document.getElementById('drawCount').value);
            
            // è·å–æœªä¸­å¥–çš„äººå‘˜
            const allWinners = [...winners['ä¸€ç­‰å¥–'], ...winners['äºŒç­‰å¥–'], ...winners['ä¸‰ç­‰å¥–']];
            const availableParticipants = participants.filter(p => 
                !allWinners.some(w => w.phone === p.phone)
            );

            if (availableParticipants.length === 0) {
                alert('æ²¡æœ‰å¯æŠ½å¥–çš„äººå‘˜ï¼');
                return;
            }

            if (drawCount < 1 || drawCount > availableParticipants.length) {
                alert(`æŠ½å–äººæ•°æ— æ•ˆï¼å½“å‰å¯æŠ½å¥–äººæ•°ï¼š${availableParticipants.length}`);
                return;
            }

            // æŠ½å¥–åŠ¨ç”»
            const winnerDisplay = document.getElementById('winnerDisplay');
            winnerDisplay.innerHTML = `<h2>${prizeType}æŠ½å¥–ä¸­...</h2>`;
            
            let count = 0;
            const interval = setInterval(() => {
                const randomPerson = availableParticipants[Math.floor(Math.random() * availableParticipants.length)];
                winnerDisplay.innerHTML = `
                    <h2>${prizeType}</h2>
                    <div class="winner-name">${randomPerson.name}</div>
                `;
                count++;
                
                if (count > 20) {
                    clearInterval(interval);
                    // çœŸæ­£æŠ½å¥–
                    drawWinners(prizeType, drawCount, availableParticipants);
                }
            }, 100);
        }

        // æ‰§è¡ŒæŠ½å¥–
        function drawWinners(prizeType, count, availableParticipants) {
            const selected = [];
            const pool = [...availableParticipants];
            
            for (let i = 0; i < count; i++) {
                const randomIndex = Math.floor(Math.random() * pool.length);
                selected.push(pool[randomIndex]);
                pool.splice(randomIndex, 1);
            }

            // ä¿å­˜ä¸­å¥–è€…
            winners[prizeType].push(...selected);
            saveData();

            // æ˜¾ç¤ºç»“æœ
            const winnerDisplay = document.getElementById('winnerDisplay');
            if (selected.length === 1) {
                winnerDisplay.innerHTML = `
                    <h2>ğŸŠ ${prizeType} ğŸŠ</h2>
                    <div class="winner-name">${selected[0].name}</div>
                    <p style="color: white; margin-top: 20px; font-size: 1.2em;">${selected[0].phone}</p>
                `;
            } else {
                const names = selected.map(w => `<div class="winner-name" style="font-size: 2em; margin: 10px;">${w.name}</div>`).join('');
                winnerDisplay.innerHTML = `
                    <h2>ğŸŠ ${prizeType} ğŸŠ</h2>
                    ${names}
                `;
            }

            updateStats();
            updateWinnersList();
        }

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats() {
            const allWinners = [...winners['ä¸€ç­‰å¥–'], ...winners['äºŒç­‰å¥–'], ...winners['ä¸‰ç­‰å¥–']];
            const remaining = participants.length - allWinners.length;

            document.getElementById('totalParticipants').textContent = participants.length;
            document.getElementById('remainingParticipants').textContent = remaining;
            document.getElementById('totalWinners').textContent = allWinners.length;
        }

        // æ›´æ–°ä¸­å¥–åå•
        function updateWinnersList() {
            const winnersListDiv = document.getElementById('winnersList');
            let html = '<h3 style="margin-bottom: 20px;">ä¸­å¥–åå•</h3>';

            ['ä¸€ç­‰å¥–', 'äºŒç­‰å¥–', 'ä¸‰ç­‰å¥–'].forEach(prizeType => {
                if (winners[prizeType].length > 0) {
                    html += `<div class="prize-section">
                        <h3>${prizeType} (${winners[prizeType].length}äºº)</h3>
                        <div>`;
                    
                    winners[prizeType].forEach(winner => {
                        html += `<span class="winner-item">${winner.name}</span>`;
                    });
                    
                    html += `</div></div>`;
                }
            });

            winnersListDiv.innerHTML = html || '<p style="text-align: center; color: #999;">æš‚æ— ä¸­å¥–è®°å½•</p>';
        }

        // æ›´æ–°å‚ä¸è€…åˆ—è¡¨
        function updateParticipantsList() {
            const listDiv = document.getElementById('participantsList');
            document.getElementById('participantCount').textContent = participants.length;

            if (participants.length === 0) {
                listDiv.innerHTML = '<p style="text-align: center; color: #999;">æš‚æ— ç­¾åˆ°äººå‘˜</p>';
                return;
            }

            let html = '';
            participants.forEach((participant, index) => {
                const isWinner = [...winners['ä¸€ç­‰å¥–'], ...winners['äºŒç­‰å¥–'], ...winners['ä¸‰ç­‰å¥–']]
                    .some(w => w.phone === participant.phone);
                const status = isWinner ? ' ğŸ†' : '';
                
                html += `
                    <div class="participant-item">
                        <div>
                            <strong>${participant.name}${status}</strong>
                            <span style="margin-left: 15px; color: #666;">${participant.phone}</span>
                            <span style="margin-left: 15px; color: #999; font-size: 0.9em;">${participant.signTime}</span>
                        </div>
                        <button class="delete-btn" onclick="deleteParticipant(${index})">åˆ é™¤</button>
                    </div>
                `;
            });

            listDiv.innerHTML = html;
        }

        // åˆ é™¤å‚ä¸è€…
        function deleteParticipant(index) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¯¥å‚ä¸è€…å—ï¼Ÿ')) {
                const participant = participants[index];
                
                // åŒæ—¶åˆ é™¤ä¸­å¥–è®°å½•
                ['ä¸€ç­‰å¥–', 'äºŒç­‰å¥–', 'ä¸‰ç­‰å¥–'].forEach(prizeType => {
                    winners[prizeType] = winners[prizeType].filter(w => w.phone !== participant.phone);
                });
                
                participants.splice(index, 1);
                saveData();
                updateStats();
                updateParticipantsList();
                updateWinnersList();
            }
        }

        // æ¸…ç©ºæ‰€æœ‰æ•°æ®
        function clearAllData() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                participants = [];
                winners = {
                    'ä¸€ç­‰å¥–': [],
                    'äºŒç­‰å¥–': [],
                    'ä¸‰ç­‰å¥–': []
                };
                saveData();
                updateStats();
                updateParticipantsList();
                updateWinnersList();
                
                document.getElementById('winnerDisplay').innerHTML = `
                    <h2>å‡†å¤‡å¼€å§‹æŠ½å¥–</h2>
                    <p style="color: white; font-size: 1.2em;">é€‰æ‹©å¥–é¡¹å’Œäººæ•°ï¼Œç‚¹å‡»å¼€å§‹æŠ½å¥–</p>
                `;
                
                alert('æ•°æ®å·²æ¸…ç©ºï¼');
            }
        }

        // å¯¼å‡ºæ•°æ®
        function exportData() {
            const data = {
                participants: participants,
                winners: winners,
                exportTime: new Date().toLocaleString('zh-CN')
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `å¹´ä¼šæŠ½å¥–æ•°æ®_${new Date().getTime()}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // å¯¼å…¥æ•°æ®
        function importData() {
            document.getElementById('importFile').click();
        }

        function handleImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.participants && data.winners) {
                        participants = data.participants;
                        winners = data.winners;
                        saveData();
                        updateStats();
                        updateParticipantsList();
                        updateWinnersList();
                        alert('æ•°æ®å¯¼å…¥æˆåŠŸï¼');
                    } else {
                        alert('æ•°æ®æ ¼å¼é”™è¯¯ï¼');
                    }
                } catch (error) {
                    alert('å¯¼å…¥å¤±è´¥ï¼š' + error.message);
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        // ä¿å­˜æ•°æ®
        function saveData() {
            if (useFirebase) {
                saveDataToFirebase();
            } else {
                localStorage.setItem('participants', JSON.stringify(participants));
                localStorage.setItem('winners', JSON.stringify(winners));
            }
        }

        // ä¿å­˜åˆ°Firebase
        function saveDataToFirebase() {
            database.ref('lottery').set({
                participants: participants,
                winners: winners,
                lastUpdate: new Date().toISOString()
            }).catch(error => {
                console.error('Firebaseä¿å­˜å¤±è´¥:', error);
                // é™çº§åˆ°æœ¬åœ°å­˜å‚¨
                localStorage.setItem('participants', JSON.stringify(participants));
                localStorage.setItem('winners', JSON.stringify(winners));
            });
        }

        // ä»FirebaseåŠ è½½æ•°æ®
        function loadDataFromFirebase() {
            database.ref('lottery').on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    participants = data.participants || [];
                    winners = data.winners || {
                        'ä¸€ç­‰å¥–': [],
                        'äºŒç­‰å¥–': [],
                        'ä¸‰ç­‰å¥–': []
                    };
                    updateStats();
                    updateParticipantsList();
                    updateWinnersList();
                }
            });
        }

        // ä»localStorageåŠ è½½æ•°æ®
        function loadData() {
            const savedParticipants = localStorage.getItem('participants');
            const savedWinners = localStorage.getItem('winners');
            
            if (savedParticipants) {
                participants = JSON.parse(savedParticipants);
            }
            
            if (savedWinners) {
                winners = JSON.parse(savedWinners);
            }
        }

        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(element, text, type) {
            element.innerHTML = `<div class="message ${type}">${text}</div>`;
            setTimeout(() => {
                element.innerHTML = '';
            }, 3000);
        }

        // ç”ŸæˆäºŒç»´ç 
        function generateQRCode() {
            const qrcodeDiv = document.getElementById('qrcode');
            const urlSpan = document.getElementById('signinUrl');
            
            // æ¸…ç©ºä¹‹å‰çš„äºŒç»´ç 
            qrcodeDiv.innerHTML = '';
            
            // ç”Ÿæˆç­¾åˆ°URL
            const baseUrl = window.location.href.split('?')[0];
            const signinUrl = baseUrl + '?mode=signin';
            
            // æ˜¾ç¤ºURL
            urlSpan.textContent = signinUrl;
            
            // ç”ŸæˆäºŒç»´ç 
            new QRCode(qrcodeDiv, {
                text: signinUrl,
                width: 256,
                height: 256,
                colorDark: '#000000',
                colorLight: '#ffffff',
                correctLevel: QRCode.CorrectLevel.H
            });
        }

        // åˆ·æ–°äºŒç»´ç 
        function refreshQRCode() {
            generateQRCode();
            alert('äºŒç»´ç å·²åˆ·æ–°ï¼');
        }
    </script>
</body>
</html>